kind: pipeline
name: default

steps:
  - name: fetch
    image: docker:git
    commands:
      - git fetch --tags

  - name: build
    image: cimg/go:1.22.6

    volumes:
    - name: dockersock
      path: /var/run/docker.sock

    environment:
      GITEA_TOKEN:
        from_secret: gitea_token

    commands:
      - sudo chmod 666 /var/run/docker.sock
      - echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
      - sudo apt update
      - sudo apt install goreleaser
      - sudo chown -R circleci:circleci .
      - /tmp/goreleaser-download release --clean

trigger:
  event:
    - tag

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock
